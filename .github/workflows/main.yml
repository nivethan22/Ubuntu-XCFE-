name: macOS Intel – Getscreen.me Remote Desktop (Working Nov 2025)

on:
  workflow_dispatch:
    inputs:
      getscreen_email:
        description: "Your Getscreen.me email"
        required: true
        type: string
      device_name:
        description: "Device name in dashboard"
        required: true
        type: string
        default: "GitHub-macOS-Intel"

jobs:
  remote-desktop:
    runs-on: macos-13
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Latest Getscreen.me Agent (2025 working link)
        run: |
          # This is the real direct link that works in November 2025
          curl -fL -o getscreen.pkg "https://getscreen.me/download/agent/macos/pkg"

          SIZE=$(stat -f%z getscreen.pkg 2>/dev/null || stat -c%s getscreen.pkg)
          echo "Downloaded getscreen.pkg – size: $SIZE bytes"
          if [ "$SIZE" -lt 10000000 ]; then
            echo "::error::File too small – probably not the real package"
            exit 1
          fi

      - name: Install Getscreen.me via .pkg (silent install)
        run: |
          sudo installer -pkg getscreen.pkg -target /

      - name: Wait for installation to complete
        run: sleep 15

      - name: Register & Configure Getscreen.me Agent
        env:
          EMAIL: ${{ inputs.getscreen_email }}
          NAME: ${{ inputs.device_name }}
        run: |
          AGENT="/Applications/Getscreen Agent.app/Contents/MacOS/Getscreen Agent"

          # Some runners have slightly different app name – try both
          if [ ! -f "$AGENT" ]; then
            AGENT="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          fi

          echo "Registering with email: $EMAIL"
          "$AGENT" -register "$EMAIL"

          echo "Setting device name: $NAME"
          "$AGENT" -config "name='$NAME' control=true file_transfer=true fast_access=true autostart=true"

          echo "Starting agent..."
          "$AGENT" -start &

      - name: Verify Agent is Running
        run: |
          sleep 10
          if pgrep -f "Getscreen" > /dev/null; then
            echo "Getscreen.me agent is running successfully!"
          else
            echo "::error::Agent failed to start"
            ps aux | grep -i getscreen
            exit 1
          fi

      - name: SUCCESS – Connect Now!
        run: |
          echo "=================================================================="
          echo "    GETSCREEN.ME IS READY – CONNECT NOW!"
          echo ""
          echo "   Email       : ${{ inputs.getscreen_email }}"
          echo "   Device Name : ${{ inputs.device_name }}"
          echo "   Dashboard   : https://my.getscreen.me"
          echo ""
          echo "   Open the link above and connect immediately!"
          echo "   This runner will stay alive for up to 6 hours."
          echo "=================================================================="

          # Keep alive loop
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            if (( MINUTES % 20 == 0 )); then
              echo "Runner still alive – $MINUTES minutes elapsed"
            fi
          done
