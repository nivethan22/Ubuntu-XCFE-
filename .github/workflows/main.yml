name: Setup XFCE with Chrome Remote Desktop

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Update and install dependencies
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install -y \
          xfce4 \
          xfce4-goodies \
          xorg \
          wget \
          curl \
          gnupg2 \
          lsb-release \
          sudo \
          xfce4-session \
          pulseaudio \
          dbus-x11 \
          xrdp

    - name: Add Google repository and install Chrome Remote Desktop
      run: |
        # Install dependencies for adding Google repository
        sudo apt install -y wget curl lsb-release gnupg

        # Add Googleâ€™s APT repository
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [signed-by=/usr/share/keyrings/google-archive-keyring.gpg] https://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list

        # Update and install Google Chrome and Chrome Remote Desktop
        sudo apt update
        sudo apt install -y google-chrome-stable
        sudo apt install -y chrome-remote-desktop

    - name: Set up Chrome Remote Desktop
      run: |
        # Create user for CRD access
        sudo useradd -m -s /bin/bash crduser
        echo "crduser:password" | sudo chpasswd
        
        # Configure Chrome Remote Desktop
        sudo apt install -y xfce4-session
        sudo apt install -y xrdp
        sudo systemctl enable xrdp
        
        # Set up XFCE session for CRD
        sudo echo "xfce4-session" > /home/crduser/.xsession
        sudo chown crduser:crduser /home/crduser/.xsession
        
        # Enable and start xrdp
        sudo systemctl restart xrdp

    - name: CRD Authentication Code (Manual Step)
      run: |
        echo "Now, follow these steps to authenticate with Chrome Remote Desktop:"
        echo "1. Open Chrome Remote Desktop on your Google Account."
        echo "2. Use the code provided by Chrome Remote Desktop to authorize the session."
        echo "3. After authorization, connect to your virtual machine via Chrome Remote Desktop."

    - name: Final Message
      run: |
        echo "Setup complete. Please connect manually using Chrome Remote Desktop. You will be prompted for your Google Account authorization code."
