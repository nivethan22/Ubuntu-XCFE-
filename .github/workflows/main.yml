name: macOS Intel â€“ Getscreen.me Remote Desktop (Nov 2025)

on:
  workflow_dispatch:
    inputs:
      getscreen_email:
        description: "Your Getscreen.me email for registration"
        required: true
        type: string
      device_name:
        description: "Device name in dashboard"
        required: true
        type: string
        default: "Mac-Intel-Runner"

jobs:
  remote-desktop:
    runs-on: macos-13
    timeout-minutes: 360

    steps:
      - name: Checkout repository (with agent ZIP)
        uses: actions/checkout@v4

      - name: Validate & Extract Agent ZIP
        run: |
          ZIP_FILE="getscreen-macos.zip"  # Download manually from dashboard and commit this file
          if [ ! -f "$ZIP_FILE" ]; then
            echo "::error::Missing $ZIP_FILE! Download macOS agent ZIP from https://my.getscreen.me > Add Device > macOS, rename to $ZIP_FILE, commit to repo root."
            exit 1
          fi
          
          echo "Extracting $ZIP_FILE..."
          unzip -q "$ZIP_FILE"
          
          if [ -d "Getscreen.app" ]; then
            mv Getscreen.app /Applications/
          elif [ -d "Getscreen Agent.app" ]; then
            mv "Getscreen Agent.app" /Applications/Getscreen.app
          else
            echo "::error::No .app bundle found."
            ls -la
            exit 1
          fi
          
          echo "âœ… Agent installed to /Applications/Getscreen.app"

      - name: Register & Configure Agent
        env:
          EMAIL: ${{ inputs.getscreen_email }}
          NAME: ${{ inputs.device_name }}
        run: |
          AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          
          if [ ! -f "$AGENT_PATH" ]; then
            AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen Agent"
          fi
          
          echo "Registering with $EMAIL"
          "$AGENT_PATH" -register "$EMAIL"
          
          echo "Configuring device: $NAME"
          "$AGENT_PATH" -config "name='$NAME' control=true file_transfer=true fast_access=true"
          
          echo "âœ… Configured"

      - name: Launch & Verify Agent
        run: |
          AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          
          if [ ! -f "$AGENT_PATH" ]; then
            AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen Agent"
          fi
          
          "$AGENT_PATH" -start &
          sleep 10
          
          if pgrep -f "Getscreen" > /dev/null; then
            echo "âœ… Agent running (PID: $(pgrep -f Getscreen))"
          else
            echo "::error::Agent failed to start"
            exit 1
          fi

      - name: Success Message & Keep Alive
        run: |
          echo "=================================================================="
          echo "ðŸŽ‰ GETSCREEN.ME READY! CONNECT NOW"
          echo "Email: ${{ inputs.getscreen_email }}"
          echo "Device: ${{ inputs.device_name }}"
          echo "Dashboard: https://my.getscreen.me"
          echo "Runner active for 6 hours."
          echo "=================================================================="
          
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            if (( MINUTES % 30 == 0 )); then
              echo "Active: $MINUTES min"
            fi
          done

      - name: Cleanup on Failure
        if: failure()
        run: |
          pkill -f Getscreen || true
          rm -rf /Applications/Getscreen.app getscreen-macos.zip
          echo "Cleanup done"
