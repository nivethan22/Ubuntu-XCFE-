name: macOS Intel - Getscreen.me Runner

on:
  workflow_dispatch:
    inputs:
      getscreen_email:
        description: 'Your Getscreen.me Account Email (for registration)'
        required: true
      device_name:
        description: 'Remote Device Name (e.g., Mac-Cloud-Runner)'
        required: true
        default: 'Mac-Cloud-Runner'
    
jobs:
  run-mac-remote-desktop:
    # Use macos-13 for a recent Intel-based Mac runner. 
    # NOTE: macos-latest is now M-series (Apple Silicon).
    runs-on: macos-13
    
    timeout-minutes: 360 # 6 hours maximum run time

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- SETUP: GETSCREEN.ME INSTALLATION ---
      
      - name: ‚¨áÔ∏è Download Getscreen.me Agent
        shell: bash
        run: |
          # Download the macOS Agent application bundle
          # The agent is a standard .app bundle packaged in a ZIP
          GETSCREEN_URL="https://getscreen.me/download/macos-agent"
          curl -o getscreen.zip $GETSCREEN_URL
          unzip getscreen.zip
          
      - name: ‚öôÔ∏è Configure and Register Getscreen.me Agent
        shell: bash
        env:
          MY_EMAIL: ${{ github.event.inputs.getscreen_email }}
          MY_NAME: ${{ github.event.inputs.device_name }}
        run: |
          AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          
          # Move the unzipped application to the standard Applications directory
          mv Getscreen.app /Applications/
          
          # The agent application file itself is the executable
          # 1. Register the agent with the user's email
          # 2. Configure the device name and enable control/file transfer
          $AGENT_PATH -register $MY_EMAIL
          $AGENT_PATH -config "name='$MY_NAME' control=true fast_access=true file_transfer=true"
          
          echo "Getscreen.me registered and configured."

      # --- FINAL STEP: LAUNCH AND KEEP ALIVE ---
      
      - name: üöÄ Launch Getscreen.me and Keep Runner Alive
        shell: bash
        run: |
          AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          
          # Launch the agent service
          # NOTE: On macOS runners, the agent may be installed as a daemon/service by default.
          # We run it here to ensure it's active.
          $AGENT_PATH -start &
          
          echo "----------------------------------------------------------------"
          echo "üéâ GETSCREEN.ME AGENT IS RUNNING. CONNECT NOW!"
          echo "1. Go to your Getscreen.me dashboard: https://my.getscreen.me/"
          echo "2. Find the device named '${{ github.event.inputs.device_name }}' (or similar)."
          echo "3. Initiate the remote connection."
          echo "----------------------------------------------------------------"

          # Keep the runner alive for the duration of the timeout
          # We use a simple loop, as closing the shell kills the process.
          while true; do
            sleep 60
          done
