name: Streaming Rig

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google CRD Authorization Command:'
        required: true
      pin:
        description: 'CRD Pin (6 digits for connection):'
        required: false
        default: '123456'

jobs:
  streaming_desktop_setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: 1. ðŸ› ï¸ Install Desktop Environment
      shell: bash
      env:
        # We will set this password for the CURRENT user
        SYS_PASS: '12345678910Nive@' 
      run: |
        echo "Installing XFCE..."
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-goodies xfce4-terminal dbus-x11 xserver-xorg x11-xserver-utils
        
        # Remove light-locker (screensaver) as it often crashes headless sessions
        sudo apt-get remove -y light-locker || true

        echo "Setting password for default user..."
        # Set password for the current GitHub user (usually 'runner')
        echo "$(whoami):$SYS_PASS" | sudo chpasswd
        
        # Add current user to sudo group just in case
        sudo usermod -aG sudo $(whoami)
        
        echo "âœ… Password set for user: $(whoami)"

    - name: 2. ðŸŒ Install & Join ZeroTier
      shell: bash
      run: |
        curl -s https://install.zerotier.com | sudo bash
        sudo zerotier-cli join d3ecf5726d2f04a6
        echo "âš ï¸ Go to https://my.zerotier.com/ and AUTHORIZE the new member now!"

    - name: 3. â¬‡ï¸ Install CRD & Sunshine
      shell: bash
      run: |
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get install -f -y
        rm chrome-remote-desktop_current_amd64.deb

        ASSET_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest | grep -oP '"browser_download_url": "\K[^"]+ubuntu-22.04-amd64.deb')
        wget -q "$ASSET_URL" -O sunshine.deb
        sudo apt-get install -y ./sunshine.deb
        rm sunshine.deb

    - name: 4. âš™ï¸ Configure Session
      shell: bash
      env:
        PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        echo "Configuring XFCE for $(whoami)..."
        
        # Configure session for the CURRENT user
        # We still use dbus-launch because GHA is headless
        cat > ~/.chrome-remote-desktop-session <<EOF
        #!/bin/sh
        unset DBUS_SESSION_BUS_ADDRESS
        unset XDG_RUNTIME_DIR
        exec /usr/bin/dbus-launch --exit-with-session /usr/bin/startxfce4
        EOF

        chmod +x ~/.chrome-remote-desktop-session

        # Create config directory
        mkdir -p ~/.config/chrome-remote-desktop
        
        # Create PIN file
        echo "$PIN" | tee ~/.config/chrome-remote-desktop/pin-auth.json > /dev/null

        # Extract Auth Code
        if [[ $INPUT_CMD =~ (4/[^[:space:]]+) ]]; then
          CODE="${BASH_REMATCH[1]}"
        else
          echo "::error::CRD Auth Code not found."
          exit 1
        fi

        echo "Starting CRD Host..."
        
        # Start CRD using the CURRENT user ($(whoami))
        printf "$PIN\n$PIN\n" | /opt/google/chrome-remote-desktop/start-host \
          --code="$CODE" \
          --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
          --name="Linux-Streaming-Rig" \
          --user-name="$(whoami)" \
          --pin-file="$HOME/.config/chrome-remote-desktop/pin-auth.json"

        # Start Sunshine
        nohup sunshine > sunshine.log 2>&1 &

        echo "----------------------------------------------------------------"
        echo "ðŸŽ‰ SETUP COMPLETE!"
        echo "ðŸ‘¤ User: $(whoami)"
        echo "ðŸ”‘ Password: 12345678910Nive@"
        echo "----------------------------------------------------------------"
        
        while true; do sleep 60; done
