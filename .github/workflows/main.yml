name: Streaming Rig (User: Demo | Admin)

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google CRD Authorization Command:'
        required: true
      pin:
        description: 'CRD Pin (6 digits for connection):'
        required: false
        default: '123456'

jobs:
  streaming_desktop_setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: 1. ðŸ› ï¸ Setup Demo User & Install Basics
      shell: bash
      env:
        # This is the system password you requested
        SYS_PASS: '12345678910Nive@' 
      run: |
        echo "Installing Desktop Environment..."
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-terminal dbus-x11 xserver-xorg

        echo "Creating user 'Demo'..."
        # Create user 'Demo' with a home directory
        sudo useradd -m -s /bin/bash Demo
        
        # Add 'Demo' to the sudo (admin) group
        sudo usermod -aG sudo Demo
        
        # Set the specific password for Demo
        echo "Demo:$SYS_PASS" | sudo chpasswd
        
        echo "âœ… User 'Demo' created with Admin privileges."
        echo "âœ… Password set to: $SYS_PASS"

    - name: 2. ðŸŒ Install & Join ZeroTier
      shell: bash
      run: |
        curl -s https://install.zerotier.com | sudo bash
        sudo zerotier-cli join d3ecf5726d2f04a6
        echo "âš ï¸ Go to https://my.zerotier.com/ and AUTHORIZE the new member now!"

    - name: 3. â¬‡ï¸ Install CRD & Sunshine
      shell: bash
      run: |
        # Install Chrome Remote Desktop
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get install -f -y
        rm chrome-remote-desktop_current_amd64.deb

        # Install Sunshine (Moonlight Host)
        ASSET_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest | grep -oP '"browser_download_url": "\K[^"]+ubuntu-22.04-amd64.deb')
        wget -q "$ASSET_URL" -O sunshine.deb
        sudo apt-get install -y ./sunshine.deb
        rm sunshine.deb

    - name: 4. âš™ï¸ Configure Session for 'Demo'
      shell: bash
      env:
        PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        echo "Configuring XFCE for Demo..."
        
        # Create the session file inside Demo's home folder
        sudo -u Demo bash -c "echo 'exec /etc/X11/Xsession /usr/bin/xfce4-session' > /home/Demo/.chrome-remote-desktop-session"
        
        # Create the config directory for Demo
        sudo -u Demo mkdir -p /home/Demo/.config/chrome-remote-desktop
        
        # Create the PIN file for Demo
        echo "$PIN" | sudo -u Demo tee /home/Demo/.config/chrome-remote-desktop/pin-auth.json > /dev/null

        # Extract the Auth Code
        if [[ $INPUT_CMD =~ (4/[^[:space:]]+) ]]; then
          CODE="${BASH_REMATCH[1]}"
        else
          echo "::error::CRD Auth Code not found."
          exit 1
        fi

        echo "Starting CRD Host as 'Demo'..."
        
        # We run the command as root (sudo), but tell it to start the session for user "Demo"
        # We pipe the PIN twice to bypass the interactive prompts
        printf "$PIN\n$PIN\n" | sudo /opt/google/chrome-remote-desktop/start-host \
          --code="$CODE" \
          --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
          --name="Linux-Streaming-Rig" \
          --user-name="Demo" \
          --pin-file="/home/Demo/.config/chrome-remote-desktop/pin-auth.json"

        # Start Sunshine as the 'Demo' user so it sees the correct desktop
        sudo -u Demo nohup sunshine > /home/Demo/sunshine.log 2>&1 &

        echo "----------------------------------------------------------------"
        echo "ðŸŽ‰ SETUP COMPLETE!"
        echo "ðŸ‘¤ Logged in User: Demo"
        echo "ðŸ”‘ System Password: 12345678910Nive@"
        echo "----------------------------------------------------------------"
        echo "1. ZeroTier: Check the box on my.zerotier.com"
        echo "2. CRD: Connect with PIN ${{ inputs.pin }}"
        echo "3. Moonlight: Pair at https://localhost:47990/pin inside the VM"
        echo "----------------------------------------------------------------"

        # Keep alive
        while true; do sleep 60; done
