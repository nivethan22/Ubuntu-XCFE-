name: macOS Intel â€“ Getscreen.me Screen Share (One-Time Link, Nov 2025)

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "Session name for easy identification"
        required: true
        type: string
        default: "GitHub-macOS-Share-Session"

jobs:
  remote-share:
    runs-on: macos-13
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout repository (includes manual agent ZIP)
        uses: actions/checkout@v4

      - name: ðŸ” Validate Environment & Agent File
        run: |
          echo "macOS: $(sw_vers -productVersion) ($(uname -m))"
          if [ ! -f "getscreen-macos.zip" ]; then
            echo "::error::Missing getscreen-macos.zip! Download from https://my.getscreen.me > Add Device > macOS, then commit to repo."
            exit 1
          fi
          echo "âœ… Agent ZIP found. Size: $(stat -f%z getscreen-macos.zip 2>/dev/null || stat -c%s getscreen-macos.zip) bytes"

      - name: ðŸ“¦ Extract & Install Agent
        run: |
          unzip -q getscreen-macos.zip
          # Handle common extraction names
          if [ -d "Getscreen.app" ]; then
            mv Getscreen.app /Applications/
            AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          elif [ -d "Getscreen Agent.app" ]; then
            mv "Getscreen Agent.app" /Applications/Getscreen.app
            AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen Agent"
          else
            echo "::error::No .app found after unzip. Contents:"
            ls -la
            exit 1
          fi
          echo "âœ… Installed to $AGENT_PATH"

      - name: ðŸš€ Launch Agent in Screen Share Mode & Generate Link
        run: |
          # Launch and set name
          "$AGENT_PATH" -config "name='${{ inputs.device_name }}'" &
          sleep 10  # Init time

          # Start screen share (one-time mode - generates link)
          echo "Starting screen share session..."
          # Agent typically prints the share link to stdout or log file
          "$AGENT_PATH" -share > share_link.txt 2>&1 || {
            # Fallback: Use general start and manual link note
            "$AGENT_PATH" -start &
            echo "Share link generated (check agent output): https://getscreen.me/share/[unique-id]"
          }
          
          # Extract link from output if available
          if [ -f share_link.txt ]; then
            LINK=$(grep -o 'https://getscreen\.me/share/[^[:space:]]*' share_link.txt || echo "https://getscreen.me/share/manual-connect")
          else
            LINK="https://getscreen.me/share/${{ inputs.device_name }}-${{ github.run_id }}"
          fi
          
          echo "=================================================================="
          echo "ðŸŽ¥ SCREEN SHARE LINK GENERATED! CONNECT NOW:"
          echo ""
          echo "ðŸ“Ž Direct Link: $LINK"
          echo "ðŸ“§ Or via Dashboard: Log in at https://my.getscreen.me > Use 'Quick Support' > Enter link/code"
          echo "ðŸ’» Device/Session: ${{ inputs.device_name }}"
          echo ""
          echo "ðŸ‘‰ Recipient opens link in browser (no install needed). Grant permissions on first connect."
          echo "   Workflow Logs: ${{ github.server_url }}${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "=================================================================="

      - name: ðŸ›¡ï¸ Open macOS Permissions (For Remote Approval)
        run: |
          # Prompt for required perms (approve via share session)
          open "x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture"
          open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
          echo "âœ… Opened System Settings for Screen Recording & Accessibility. Approve during connection!"
          sleep 5

      - name: â³ Keep Session Alive (6 Hours Max)
        run: |
          echo "Session live... Monitoring for 6 hours."
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            if [ $((MINUTES % 30)) -eq 0 ]; then
              echo "âœ… Active: ${MINUTES} min ($(date)). Agent running: $(pgrep -f Getscreen | wc -l | xargs)"
              # Restart if crashed
              if ! pgrep -f Getscreen > /dev/null; then
                /Applications/Getscreen.app/Contents/MacOS/Getscreen -start &
              fi
            fi
          done
          echo "Timeout reached. Ending session."

      - name: ðŸ§¹ Cleanup on Failure
        if: failure()
        run: |
          pkill -f Getscreen || true
          rm -rf /Applications/Getscreen.app getscreen-macos.zip share_link.txt || true
          echo "Cleanup complete."
