name: macOS Intel – Getscreen.me Remote Desktop

on:
  workflow_dispatch:
    inputs:
      getscreen_email:
        description: "Your Getscreen.me account email (for agent registration)"
        required: true
        type: string
      device_name:
        description: "Name that will appear in your Getscreen.me dashboard"
        required: true
        type: string
        default: "GitHub-macOS-Intel-Runner"

jobs:
  remote-desktop:
    name: Start Getscreen.me on macOS Intel
    runs-on: macos-13
    timeout-minutes: 360

    steps:
      # ------------------------------------------------------------------
      # 1. Checkout (optional – only if you need files from the repo)
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # 2. Download the latest Getscreen.me macOS agent (2025 working URL)
      # ------------------------------------------------------------------
      - name: Download Getscreen.me Agent
        run: |
          # Official direct download link as of 2025
          URL="https://getscreen.me/download/agent/macos"

          echo "Downloading Getscreen.me agent from: $URL"
          curl -fL --retry 5 --retry-delay 10 -o getscreen.dmg "$URL"

          # Safety checks
          if [ ! -f getscreen.dmg ]; then
            echo "::error::Download failed – file not created"
            exit 1
          fi

          SIZE=$(stat -f%z getscreen.dmg 2>/dev/null || stat -c%s getscreen.dmg)
          echo "Downloaded file size: $SIZE bytes"
          if [ "$SIZE" -lt 5000000 ]; then  # < 5 MB → probably HTML error page
            echo "::error::File too small – likely an HTML error page instead of DMG"
            head -n 30 getscreen.dmg
            exit 1
          fi

          echo "Download successful!"

      # ------------------------------------------------------------------
      # 3. Mount DMG & copy Getscreen.app to /Applications
      # ------------------------------------------------------------------
      - name: Mount DMG and Install Getscreen.app
        run: |
          hdiutil attach getscreen.dmg -mountpoint /Volumes/Getscreen
          cp -R "/Volumes/Getscreen/Getscreen Agent.app" /Applications/Getscreen.app || \
          cp -R "/Volumes/Getscreen/Getscreen.app" /Applications/Getscreen.app
          hdiutil detach /Volumes/Getscreen
          echo "Getscreen.app installed to /Applications/"

      # ------------------------------------------------------------------
      # 4. Register & configure the agent
      # ------------------------------------------------------------------
      - name: Register & Configure Getscreen.me Agent
        env:
          EMAIL: ${{ inputs.getscreen_email }}
          NAME: ${{ inputs.device_name }}
        run: |
          AGENT="/Applications/Getscreen.app/Contents/MacOS/Getscreen"

          echo "Registering agent with email: $EMAIL"
          "$AGENT" -register "$EMAIL"

          echo "Setting device name to: $NAME"
          "$AGENT" -config "name='$NAME' control=true fast_access=true file_transfer=true autostart=true"

          echo "Registration & configuration complete"

      # ------------------------------------------------------------------
      # 5. Verify agent is running
      # ------------------------------------------------------------------
      - name: Verify Agent is Running
        run: |
          AGENT="/Applications/Getscreen.app/Contents/MacOS/Getscreen"
          sleep 8
          "$AGENT" -start &
          sleep 5

          if pgrep -x "Getscreen" > /dev/null; then
            echo "Getscreen.me agent is running!"
          else
            echo "::error::Agent failed to start"
            exit 1
          fi

      # ------------------------------------------------------------------
      # 6. Final success message + keep-alive loop (6 hours max)
      # ------------------------------------------------------------------
      - name: Launch Success Message & Keep Runner Alive
        run: |
          echo "================================================================================================="
          echo "GETSCREEN.ME AGENT IS NOW ONLINE AND READY!"
          echo ""
          echo "Email      : ${{ inputs.getscreen_email }}"
          echo "Device name: ${{ inputs.device_name }}"
          echo "Dashboard  : https://my.getscreen.me"
          echo ""
          echo "Connect from your browser NOW – the runner will auto-terminate after 6 hours."
          echo "================================================================================================="

          # Keep the job alive for the full 6 hours
          echo "Keeping runner alive (max 6 hours)..."
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            [ $((MINUTES % 30)) -eq 0 ] && echo "Still alive – $MINUTES minutes elapsed"
          done

          echo "6-hour limit reached. Runner shutting down."
