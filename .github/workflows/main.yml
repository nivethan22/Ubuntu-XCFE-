name: macOS Intel - Getscreen.me Runner

on:
  workflow_dispatch:
    inputs:
      getscreen_email:
        description: 'Your Getscreen.me Account Email (for registration)'
        required: true
      device_name:
        description: 'Remote Device Name (e.g., Mac-Cloud-Runner)'
        required: true
        default: 'Mac-Cloud-Runner'

jobs:
  run-mac-remote-desktop:
    runs-on: macos-13

    timeout-minutes: 360 # 6 hours maximum run time

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Download Getscreen.me Agent
        shell: bash
        run: |
          # Download the macOS Agent application bundle with macOS-specific User-Agent to get the correct ZIP
          GETSCREEN_URL="https://getscreen.me/download/macos-agent"

          echo "Attempting to download agent from: $GETSCREEN_URL"
          curl -fL -o getscreen.zip \
            --user-agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.1 Safari/605.1.15" \
            $GETSCREEN_URL

          # Check file size (should be ~10-20 MB for valid ZIP)
          FILE_SIZE=$(stat -f%z getscreen.zip 2>/dev/null || stat -c%s getscreen.zip)
          echo "Downloaded file size: ${FILE_SIZE} bytes"
          if [ "${FILE_SIZE}" -lt 1000000 ]; then
            echo "::error::Download failed - file too small (likely wrong file type). Check URL or User-Agent."
            head -n 20 getscreen.zip  # Debug: show first lines if HTML
            exit 1
          fi

          # Verify it's a ZIP
          if ! file getscreen.zip | grep -q "Zip archive"; then
            echo "::error::Downloaded file is not a ZIP (possibly Linux binary). File type:"
            file getscreen.zip
            exit 1
          fi

          echo "Download successful. Unzipping agent..."
          unzip -q getscreen.zip || {
            echo "::error::Unzip failed. Archive may be corrupted."
            unzip -t getscreen.zip
            exit 1
          }

          # Verify extraction
          if [ ! -d "Getscreen.app" ]; then
            echo "::error::No Getscreen.app found after unzip. Directory contents:"
            ls -la
            exit 1
          fi

          echo "âœ… Agent extracted successfully."

      - name: âš™ï¸ Configure and Register Getscreen.me Agent
        shell: bash
        env:
          MY_EMAIL: ${{ inputs.getscreen_email }}
          MY_NAME: ${{ inputs.device_name }}
        run: |
          mv Getscreen.app /Applications/
          AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"

          # Install daemon for persistence (optional for ephemeral, but ensures it runs)
          "$AGENT_PATH" -install

          # Register with email
          "$AGENT_PATH" -register "$MY_EMAIL"

          # Configure name and features
          "$AGENT_PATH" -config "name='$MY_NAME' control=true fast_access=true file_transfer=true audio_calls=true lock_input=true disable_confirmation=true"

          echo "âœ… Getscreen.me registered and configured."

      - name: ðŸš€ Launch Getscreen.me and Keep Runner Alive
        shell: bash
        run: |
          AGENT_PATH="/Applications/Getscreen.app/Contents/MacOS/Getscreen"

          # Start the service
          "$AGENT_PATH" -start &

          # Wait for startup
          sleep 10

          # Verify running
          if pgrep -f "Getscreen" > /dev/null; then
            echo "âœ… Agent is running (PID: $(pgrep -f Getscreen))"
          else
            echo "::error::Failed to start Getscreen.me agent."
            exit 1
          fi

          echo "----------------------------------------------------------------"
          echo "ðŸŽ‰ GETSCREEN.ME AGENT IS RUNNING. CONNECT NOW!"
          echo "1. Go to your Getscreen.me dashboard: https://my.getscreen.me/"
          echo "2. Find the device named '${{ inputs.device_name }}'."
          echo "3. Initiate the remote connection."
          echo "âš ï¸ Runner will terminate after 6 hours or manual cancel."
          echo "----------------------------------------------------------------"

          # Monitor and keep alive for 6 hours
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            if [ $((MINUTES % 30)) -eq 0 ]; then
              echo "â° Still active: ${MINUTES} minutes elapsed ($(date))"
            fi
            # Check if agent is still running
            if ! pgrep -f "Getscreen" > /dev/null; then
              echo "::warning::Agent stopped - restarting..."
              "$AGENT_PATH" -start &
              sleep 5
            fi
          done

          echo "â° 6-hour limit reached. Terminating..."

      - name: ðŸ§¹ Cleanup on Failure
        if: failure()
        shell: bash
        run: |
          echo "Cleaning up..."
          /Applications/Getscreen.app/Contents/MacOS/Getscreen -stop 2>/dev/null || true
          /Applications/Getscreen.app/Contents/MacOS/Getscreen -uninstall 2>/dev/null || true
          rm -rf /Applications/Getscreen.app getscreen.zip
          echo "âœ… Cleanup done."
