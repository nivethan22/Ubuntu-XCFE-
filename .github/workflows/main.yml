name: Streaming Rig

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google CRD Authorization Command:'
        required: true
      pin:
        description: 'CRD Pin (6 digits for connection):'
        required: false
        default: '123456'

jobs:
  streaming_desktop_setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: 1. ðŸ› ï¸ Setup Demo User & Install Basics
      shell: bash
      env:
        SYS_PASS: '12345678910Nive@' 
      run: |
        echo "Installing Desktop Environment..."
        sudo apt-get update
        # Install xfce4 and xfce4-goodies (essential for the panel/icons to load)
        sudo apt-get install -y xfce4 xfce4-goodies xfce4-terminal dbus-x11 xserver-xorg x11-xserver-utils

        echo "Creating user 'Demo'..."
        sudo useradd -m -s /bin/bash Demo
        sudo usermod -aG sudo Demo
        echo "Demo:$SYS_PASS" | sudo chpasswd
        echo "âœ… User 'Demo' created."

    - name: 2. ðŸŒ Install & Join ZeroTier
      shell: bash
      run: |
        curl -s https://install.zerotier.com | sudo bash
        sudo zerotier-cli join d3ecf5726d2f04a6
        echo "âš ï¸ Go to https://my.zerotier.com/ and AUTHORIZE the new member now!"

    - name: 3. â¬‡ï¸ Install CRD & Sunshine
      shell: bash
      run: |
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get install -f -y
        rm chrome-remote-desktop_current_amd64.deb

        ASSET_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest | grep -oP '"browser_download_url": "\K[^"]+ubuntu-22.04-amd64.deb')
        wget -q "$ASSET_URL" -O sunshine.deb
        sudo apt-get install -y ./sunshine.deb
        rm sunshine.deb

    - name: 4. âš™ï¸ Configure Session for 'Demo'
      shell: bash
      env:
        PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        echo "Configuring XFCE for Demo..."
        
        # --- FIX: Improved Session Script ---
        # 1. We create the file as root first to ensure correct content
        # 2. We use startxfce4 (wrapper) instead of xfce4-session (binary)
        # 3. We explicitly set XDG_CONFIG_DIRS so it finds the defaults
        
        sudo bash -c "cat > /home/Demo/.chrome-remote-desktop-session <<EOF
        #!/bin/sh
        unset DBUS_SESSION_BUS_ADDRESS
        unset XDG_RUNTIME_DIR
        export XDG_CONFIG_DIRS=/etc/xdg
        exec /usr/bin/startxfce4
        EOF"

        # Ensure the file is executable and owned by Demo
        sudo chmod +x /home/Demo/.chrome-remote-desktop-session
        sudo chown Demo:Demo /home/Demo/.chrome-remote-desktop-session

        # Create config dir
        sudo -u Demo mkdir -p /home/Demo/.config/chrome-remote-desktop
        
        # Create PIN file
        echo "$PIN" | sudo -u Demo tee /home/Demo/.config/chrome-remote-desktop/pin-auth.json > /dev/null

        # --- FIX: Permission Sweep ---
        # Ensure Demo owns their home dir recursively (fixes 'unable to create cache' errors)
        sudo chown -R Demo:Demo /home/Demo/

        # Extract Auth Code
        if [[ $INPUT_CMD =~ (4/[^[:space:]]+) ]]; then
          CODE="${BASH_REMATCH[1]}"
        else
          echo "::error::CRD Auth Code not found."
          exit 1
        fi

        echo "Starting CRD Host as 'Demo'..."
        
        printf "$PIN\n$PIN\n" | sudo /opt/google/chrome-remote-desktop/start-host \
          --code="$CODE" \
          --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
          --name="Linux-Streaming-Rig" \
          --user-name="Demo" \
          --pin-file="/home/Demo/.config/chrome-remote-desktop/pin-auth.json"

        sudo -u Demo nohup sunshine > /home/Demo/sunshine.log 2>&1 &

        echo "----------------------------------------------------------------"
        echo "ðŸŽ‰ SETUP COMPLETE!"
        echo "----------------------------------------------------------------"
        
        while true; do sleep 60; done
