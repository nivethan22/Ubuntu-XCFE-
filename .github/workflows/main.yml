name: Setup XFCE with Chrome Remote Desktop

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Update and install dependencies
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install -y \
          xfce4 \
          xfce4-goodies \
          xorg \
          wget \
          curl \
          gnupg2 \
          lsb-release \
          sudo \
          xfce4-session \
          pulseaudio \
          dbus-x11 \
          xrdp

    - name: Install Google Chrome for CRD
      run: |
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb
        sudo apt --fix-broken install -y

    - name: Set up Chrome Remote Desktop
      run: |
        # Create user for CRD access
        sudo useradd -m -s /bin/bash crduser
        echo "crduser:password" | sudo chpasswd
        
        # Configure Chrome Remote Desktop
        sudo apt install -y chrome-remote-desktop
        
        # Set up XFCE session for CRD
        sudo echo "xfce4-session" > /home/crduser/.xsession
        sudo chown crduser:crduser /home/crduser/.xsession
        
        # Add the user to the sudoers list (optional, depending on setup)
        sudo usermod -aG sudo crduser
        
        # Enable and start xrdp
        sudo systemctl enable xrdp
        sudo systemctl start xrdp
        
        # Setup Google Chrome
        sudo apt install -y google-chrome-stable
        
    - name: CRD Authentication Code (Manual Step)
      run: |
        echo "Now, follow these steps to authenticate with Chrome Remote Desktop:"
        echo "1. Open Chrome Remote Desktop on your Google Account."
        echo "2. Use the code provided by Chrome Remote Desktop to authorize the session."
        echo "3. After authorization, connect to your virtual machine via Chrome Remote Desktop."

    - name: Final Message
      run: |
        echo "Setup complete. Please connect manually using Chrome Remote Desktop. You will be prompted for your Google Account authorization code."
