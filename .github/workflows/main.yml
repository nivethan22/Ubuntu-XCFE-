name: macOS Intel - RustDesk Remote Desktop Runner

on:
  workflow_dispatch:
    inputs:
      device_password:
        description: 'Permanent password for unattended access (choose a strong one)'
        required: true
        default: 'securepassword123'

jobs:
  run-mac-remote-desktop:
    runs-on: macos-13
    timeout-minutes: 360 # 6 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Download RustDesk (Latest macOS Intel DMG)
        shell: bash
        run: |
          # Use latest stable release as of Nov 2025 - update if needed from https://github.com/rustdesk/rustdesk/releases
          RUSTDESK_URL="https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.dmg"
          echo "Downloading from: $RUSTDESK_URL"
          curl -fL -o rustdesk.dmg "$RUSTDESK_URL"
          if [ ! -s rustdesk.dmg ]; then
            echo "::error::Download failed"
            exit 1
          fi
          echo "‚úÖ Downloaded"

      - name: üì¶ Install RustDesk from DMG
        shell: bash
        run: |
          hdiutil attach rustdesk.dmg -mountpoint /Volumes/RustDesk
          cp -R /Volumes/RustDesk/RustDesk.app /Applications/
          hdiutil detach /Volumes/RustDesk
          echo "‚úÖ Installed to /Applications"

      - name: ‚öôÔ∏è Configure Config File for Unattended Access
        shell: bash
        env:
          PASSWORD: ${{ inputs.device_password }}
        run: |
          CONFIG_DIR="$HOME/Library/Preferences"
          CONFIG_FILE="$CONFIG_DIR/RustDesk2.toml"
          
          mkdir -p "$CONFIG_DIR"
          touch "$CONFIG_FILE"
          
          # Set plain password (app will hash on start) and access mode to accept permanent
          echo "password = '$PASSWORD'" >> "$CONFIG_FILE"
          echo "access_mode = 'use-both-passwords'" >> "$CONFIG_FILE"
          
          echo "‚úÖ Config file created at $CONFIG_FILE with password and access mode set"

      - name: üöÄ Launch RustDesk and Verify (Hashes Password)
        shell: bash
        run: |
          AGENT_PATH="/Applications/RustDesk.app/Contents/MacOS/rustdesk"
          
          # Launch to hash the password and apply config
          "$AGENT_PATH" &
          sleep 15  # Give time to load and hash
          
          # Get ID
          ID=$("$AGENT_PATH" --get-id)
          echo "RustDesk ID: $ID"
          
          # Verify running
          if pgrep -f "rustdesk" > /dev/null; then
            echo "‚úÖ Running (PID: $(pgrep -f rustdesk))"
          else
            echo "::error::Failed to start"
            exit 1
          fi

      - name: üõ°Ô∏è Open Permissions Settings (Approve on Connect)
        shell: bash
        run: |
          open "x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture"
          open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
          echo "‚úÖ Permissions opened - approve remotely on first connect"

      - name: üéâ Connect Now & Keep Alive
        shell: bash
        env:
          PASSWORD: ${{ inputs.device_password }}
        run: |
          AGENT_PATH="/Applications/RustDesk.app/Contents/MacOS/rustdesk"
          ID=$("$AGENT_PATH" --get-id)
          
          echo "----------------------------------------------------------------"
          echo "RustDesk running! Connect now:"
          echo "1. Download client: https://rustdesk.com/"
          echo "2. ID: $ID"
          echo "3. Password: $PASSWORD"
          echo "4. Connect and approve permissions."
          echo "‚ö†Ô∏è Active for 6 hours."
          echo "----------------------------------------------------------------"
          
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            if [ $((MINUTES % 30)) -eq 0 ]; then
              echo "‚è∞ Active: ${MINUTES} minutes ($(date))"
              if ! pgrep -f "rustdesk" > /dev/null; then
                echo "::warning::Stopped - restarting"
                "$AGENT_PATH" &
                sleep 5
              fi
            fi
          done
          echo "‚è∞ Timeout"

      - name: üßπ Cleanup on Failure
        if: failure()
        shell: bash
        run: |
          pkill -f rustdesk || true
          rm -rf /Applications/RustDesk.app rustdesk.dmg
          echo "‚úÖ Cleanup done"
