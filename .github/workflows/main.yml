name: Debian/Ubuntu Streaming Rig (CRD + Moonlight)

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google CRD Authorization Command (Windows format expected):'
        required: true
      pin:
        description: 'CRD Pin (Default: 123456 - Max 6 digits)'
        required: false
        default: '123456'

jobs:
  streaming_desktop_setup:
    # Use the latest Ubuntu runner
    runs-on: ubuntu-latest
    
    # Increase timeout to max allowed
    timeout-minutes: 360

    steps:
    - name: 1. â¬‡ï¸ Install Core Dependencies (CRD, XFCE, Xorg)
      shell: bash
      run: |
        echo "Installing core dependencies..."
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-terminal lightdm dbus-x11 xserver-xorg

        # Download and install CRD
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get install -f -y
        rm chrome-remote-desktop_current_amd64.deb
        echo "âœ… CRD & XFCE Installation complete."

    - name: 2. ðŸŽ® Install Sunshine (Moonlight Host)
      shell: bash
      run: |
        echo "Downloading latest Sunshine release from LizardByte..."
        
        # Fetch latest URL for Ubuntu 22.04
        ASSET_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest | grep -oP '"browser_download_url": "\K[^"]+ubuntu-22.04-amd64.deb')
        
        echo "Downloading: $ASSET_URL"
        wget -q "$ASSET_URL" -O sunshine.deb
        
        sudo apt-get update
        sudo apt-get install -y ./sunshine.deb
        rm sunshine.deb
        echo "âœ… Sunshine installed."

    - name: 3. âš™ï¸ Configure XFCE/CRD and Start Services
      shell: bash
      env:
        MY_PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        echo "Configuring desktop session..."

        # --- A. CRD Configuration ---
        # Set XFCE as the default session
        echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > ~/.chrome-remote-desktop-session

        # Create config directory
        mkdir -p ~/.config/chrome-remote-desktop
        
        # Create the PIN file manually (since pin-auth.py is missing in newer versions)
        echo "${{ inputs.pin }}" > /home/runner/.config/chrome-remote-desktop/pin-auth.json

        # Extract CRD Auth Code
        if [[ $INPUT_CMD =~ (4/[^[:space:]]+) ]]; then
          CODE="${BASH_REMATCH[1]}"
        else
          echo "::error::CRD Auth Code not found. Check input."
          exit 1
        fi

        CRD_BINARY="/opt/google/chrome-remote-desktop/start-host"

        # Start CRD Host
        # Added --user-name="runner" to fix the "missing args" error
        sudo $CRD_BINARY --code="$CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="Linux-Streaming-Rig" --pin-file="/home/runner/.config/chrome-remote-desktop/pin-auth.json" --user-name="runner"

        # --- B. Start Sunshine ---
        nohup sunshine > sunshine.log 2>&1 &
        echo "Sunshine started."

        echo "----------------------------------------------------------------"
        echo "ðŸŽ‰ SETUP COMPLETE!"
        echo "1. CRD Access: https://remotedesktop.google.com/access"
        echo "   - Connect using PIN: ${{ inputs.pin }}"
        echo "2. Moonlight Access: Pair using PIN from https://localhost:47990/ inside the CRD session."
        echo "----------------------------------------------------------------"

        # Keep runner alive
        while true; do
          sleep 60
        done
