name: macOS Intel - RustDesk Remote Desktop Runner

on:
  workflow_dispatch:
    inputs:
      device_password:
        description: 'Permanent password for unattended access (choose a strong one)'
        required: true
        default: 'securepassword123'

jobs:
  run-mac-remote-desktop:
    runs-on: macos-13
    timeout-minutes: 360 # 6 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Download RustDesk (Latest macOS Intel DMG)
        shell: bash
        run: |
          RUSTDESK_URL="https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.dmg"  # Update if newer version available
          echo "Downloading RustDesk from: $RUSTDESK_URL"
          curl -fL -o rustdesk.dmg "$RUSTDESK_URL"

          # Validate
          if [ ! -s rustdesk.dmg ]; then
            echo "::error::Download failed"
            exit 1
          fi
          echo "âœ… Download successful"

      - name: ğŸ“¦ Install RustDesk from DMG
        shell: bash
        run: |
          hdiutil attach rustdesk.dmg -mountpoint /Volumes/RustDesk
          cp -R /Volumes/RustDesk/RustDesk.app /Applications/
          hdiutil detach /Volumes/RustDesk
          echo "âœ… RustDesk installed to /Applications"

      - name: âš™ï¸ Configure Unattended Access
        shell: bash
        env:
          PASSWORD: ${{ inputs.device_password }}
        run: |
          AGENT_PATH="/Applications/RustDesk.app/Contents/MacOS/rustdesk"

          # Set permanent password for unattended access
          "$AGENT_PATH" --password "$PASSWORD"

          # Get the ID
          ID=$("$AGENT_PATH" --get-id)
          echo "RustDesk ID: $ID"

          echo "âœ… Configured with password: $PASSWORD"

      - name: ğŸš€ Launch RustDesk and Verify
        shell: bash
        run: |
          AGENT_PATH="/Applications/RustDesk.app/Contents/MacOS/rustdesk"

          # Launch in background
          "$AGENT_PATH" &
          sleep 10

          # Verify running
          if pgrep -f "rustdesk" > /dev/null; then
            echo "âœ… RustDesk running (PID: $(pgrep -f rustdesk))"
          else
            echo "::error::Failed to start RustDesk"
            exit 1
          fi

      - name: ğŸ›¡ï¸ Open Permissions Settings (Approve on Connect)
        shell: bash
        run: |
          # Open System Settings for approvals (you'll approve during remote session)
          open "x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture"
          open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
          echo "âœ… Permissions panes opened - approve when you connect remotely"

      - name: ğŸ‰ Connect Now & Keep Alive
        shell: bash
        env:
          PASSWORD: ${{ inputs.device_password }}
        run: |
          ID=$("/Applications/RustDesk.app/Contents/MacOS/rustdesk" --get-id)

          echo "----------------------------------------------------------------"
          echo "RustDesk is running! Connect now:"
          echo "1. Download RustDesk client: https://rustdesk.com/"
          echo "2. Enter ID: $ID"
          echo "3. Enter Password: $PASSWORD"
          echo "4. Connect and approve permissions in the opened settings."
          echo "âš ï¸ Runner active for 6 hours."
          echo "----------------------------------------------------------------"

          # Keep alive loop with monitoring
          MINUTES=0
          while [ $MINUTES -lt 360 ]; do
            sleep 60
            MINUTES=$((MINUTES + 1))
            if [ $((MINUTES % 30)) -eq 0 ]; then
              echo "â° Active: ${MINUTES} minutes ($(date))"
              # Restart if crashed
              if ! pgrep -f "rustdesk" > /dev/null; then
                echo "::warning::RustDesk stopped - restarting"
                /Applications/RustDesk.app/Contents/MacOS/rustdesk &
                sleep 5
              fi
            fi
          done
          echo "â° Timeout reached"

      - name: ğŸ§¹ Cleanup on Failure
        if: failure()
        shell: bash
        run: |
          pkill -f rustdesk || true
          rm -rf /Applications/RustDesk.app rustdesk.dmg
          echo "âœ… Cleanup done"
