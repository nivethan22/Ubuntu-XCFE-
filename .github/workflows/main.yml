name: Debian/Ubuntu Streaming Rig (CRD + Moonlight)

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google CRD Authorization Command (Windows format expected):'
        required: true
      pin:
        description: 'CRD Pin (Default: 123456 - Max 6 digits)'
        required: false
        default: '123456'

jobs:
  streaming_desktop_setup:
    # Use the latest Ubuntu runner (Debian derivative)
    runs-on: ubuntu-latest
    
    # Increase the maximum job timeout to allow for longer streaming sessions
    timeout-minutes: 360 # 6 hours, or your repository's max limit

    steps:
    - name: 1. â¬‡ï¸ Install Core Dependencies (CRD, XFCE, Xorg)
      shell: bash
      run: |
        echo "Installing core dependencies (CRD, XFCE, Xorg server, curl, wget, dbus)..."
        
        # Install XFCE Desktop, Xorg Server, and related tools
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-terminal lightdm dbus-x11 xserver-xorg

        # Download and install CRD Debian package.
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        # Use dpkg and apt-get install -f to handle all dependencies
        sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get install -f -y

        # Clean up the .deb file
        rm chrome-remote-desktop_current_amd64.deb
        echo "âœ… CRD & XFCE Installation complete."

    - name: 2. ðŸŽ® Install Sunshine (Moonlight Host)
      shell: bash
      run: |
        echo "Adding Sunshine PPA and installing..."
        # Add the Sunshine PPA (Personal Package Archive)
        sudo add-apt-repository ppa:loki-dev/sunshine -y
        # Update package lists
        sudo apt-get update
        # Install Sunshine
        sudo apt-get install -y sunshine

        echo "âœ… Sunshine installed."

    - name: 3. âš™ï¸ Configure XFCE/CRD and Start Services
      shell: bash
      env:
        MY_PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        echo "Configuring desktop session and starting CRD/Sunshine..."

        # --- A. CRD Configuration ---
        # Tell CRD to use the XFCE session manager.
        echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > ~/.chrome-remote-desktop-session

        # Ensure the pin is set correctly for the current user
        /opt/google/chrome-remote-desktop/pin-auth.py --set-pin=${{ inputs.pin }}

        # Extract the CRD authorization code (the 4/...) from the input string
        if [[ $INPUT_CMD =~ (4/[^[:space:]]+) ]]; then
          CODE="${BASH_REMATCH[1]}"
        else
          echo "::error::CRD Auth Code not found in input. Ensure you provided the full PowerShell command."
          exit 1
        fi

        # The path to the CRD host binary on Linux
        CRD_BINARY="/opt/google/chrome-remote-desktop/start-host"

        # Execute the CRD host startup command
        # This registers the host using the authorization code and sets the name.
        sudo $CRD_BINARY --code="$CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="Linux-Streaming-Rig" --pin-file="/home/runner/.config/chrome-remote-desktop/pin-auth.json"

        # --- B. Start Sunshine ---
        # The service needs to run under the correct user to interact with the desktop session
        nohup sunshine > sunshine.log 2>&1 &
        SUNSHINE_PID=$!
        echo "Sunshine started with PID: $SUNSHINE_PID"

        echo "----------------------------------------------------------------"
        echo "ðŸŽ‰ SETUP COMPLETE!"
        echo "1. CRD Access: Go to https://remotedesktop.google.com/access"
        echo "   - Find 'Linux-Streaming-Rig' and connect using PIN: ${{ inputs.pin }}"
        echo "2. Moonlight Access (via CRD): Pair using the PIN displayed on http://localhost:47990/ in the CRD session."
        echo "----------------------------------------------------------------"

        # Loop indefinitely to keep the job alive
        echo "Keeping the runner alive for streaming..."
        while true; do
          sleep 60
        done
