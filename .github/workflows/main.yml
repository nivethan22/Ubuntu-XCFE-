name: Setup XFCE with Chrome Remote Desktop

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Update and install dependencies
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install -y \
          xfce4 \
          xfce4-goodies \
          xorg \
          chrome-remote-desktop \
          pulseaudio \
          dbus-x11 \
          wget \
          curl \
          gnupg2 \
          lsb-release \
          sudo

    - name: Set up Chrome Remote Desktop
      run: |
        # Download and install the Google Chrome browser for CRD
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb
        sudo apt --fix-broken install -y
        
        # Create user for CRD
        sudo useradd -m -s /bin/bash crduser
        echo "crduser:password" | sudo chpasswd
        
        # Set up Chrome Remote Desktop
        sudo apt install -y xfce4-session
        sudo apt install -y xrdp
        sudo systemctl enable xrdp
        
        # Configure Google Chrome Remote Desktop
        sudo mkdir -p /etc/opt/chrome_remote_desktop
        echo "crduser" | sudo tee /etc/opt/chrome_remote_desktop/remote_desktop_user.txt
        
        # Start Xfce desktop environment
        echo "xfce4-session" > ~/.xsession
        sudo systemctl restart xrdp

    - name: Expose CRD via GitHub Actions (Not directly possible)
      run: |
        echo "GitHub Actions cannot directly expose CRD over the web, but follow the instructions to connect to the desktop manually using the IP."

    - name: Notify for manual connection
      run: |
        echo "You can now manually connect to the desktop environment via Chrome Remote Desktop using the credentials set above."
